<?xml version="1.0" encoding="UTF-8"?>
<entities do-package="com.dianping.cat.hadoop.dal" gen="true">
	<entity name="logview">
		<var name="direction" value-type="boolean" />
		<var name="message-ids" value-type="String[]" />
		<query-defs>
			<query name="find-next-by-message-id-tags" type="SELECT">
				<param name="message-id" />
				<param name="direction" />
				<param name="tag-thread" />
				<param name="tag-session" />
				<param name="tag-request" />
				<statement><![CDATA[
			        SELECT <FIELDS/> 
			        FROM <TABLE/> 
			        WHERE 1 = 1
			        	<IF type='NOT_NULL' field='tag-thread'>
					        AND <FIELD name='tag-thread'/> = ${tag-thread}
			        	</IF>
			        	<IF type='NOT_NULL' field='tag-session'>
					        AND <FIELD name='tag-session'/> = ${tag-session}
			        	</IF>
			        	<IF type='NOT_NULL' field='tag-request'>
					        AND <FIELD name='tag-request'/> = ${tag-request}
			        	</IF>
			        	<IF type='EQ' field='direction' value='true'>
					        AND <FIELD name='message-id'/> \\> ${message-id}
				        	ORDER BY <FIELD name='message-id'/> ASC 
			        	</IF>
			        	<IF type='EQ' field='direction' value='false'>
					        AND <FIELD name='message-id'/> \\< ${message-id}
				        	ORDER BY <FIELD name='message-id'/> DESC 
			        	</IF>
			        	LIMIT 1 
		        ]]></statement>
			</query>
			<query name="find-all-by-message-ids" type="SELECT" multiple="true">
				<param name="message-ids" />
				<statement><![CDATA[
					SELECT <FIELDS/> 
					FROM <TABLE/> 
					WHERE <FIELD name='message-id'/> <IN> ${message-ids} </IN>
				]]></statement>
			</query>
			<query name="find-by-message-id" type="SELECT">
				<param name="message-id" />
				<statement><![CDATA[
					SELECT <FIELDS/> 
					FROM <TABLE/> 
					WHERE <FIELD name='message-id'/> = ${message-id}
				]]></statement>
			</query>
			<query name="insert" type="INSERT" batch="true">
				<statement><![CDATA[
	           INSERT 
	           INTO <TABLE/>(<FIELDS/>) 
	           VALUES(<VALUES/>)
	           ]]></statement>
			</query>
		</query-defs>
	</entity>
	<entity name="report" table="report" alias="r">
		<member name="creation-date" insert-expr="NOW()" />
		<var name="start-date" value-type="Date" />
		<var name="end-date" value-type="Date" />
		<query-defs>
			<query name="find-all-by-domain-name-duration" type="SELECT"
				multiple="true">
				<param name="start-date" />
				<param name="end-date" />
				<param name="domain" />
				<param name="name" />
				<statement><![CDATA[
					SELECT <FIELDS/> 
					FROM <TABLE/> 
					WHERE <FIELD name='period'/> >= ${start-date}
					AND <FIELD name='period'/> < ${end-date}
					AND <FIELD name='domain'/> = ${domain}
					AND <FIELD name='name'/> = ${name}
					]]></statement>
			</query>
			<query name="find-all-by-period-domain-name" type="SELECT"
				multiple="true">
				<param name="period" />
				<param name="domain" />
				<param name="name" />
				<statement><![CDATA[
					SELECT <FIELDS/> 
					FROM <TABLE/> 
					WHERE <FIELD name='period'/> = ${period}
					AND <FIELD name='domain'/> = ${domain}
					AND <FIELD name='name'/> = ${name}
					]]></statement>
			</query>
			<query name="find-all-by-period-domain-type-name" type="SELECT"
				multiple="true">
				<param name="period" />
				<param name="domain" />
				<param name="type" />
				<param name="name" />
				<statement><![CDATA[
					SELECT <FIELDS/> 
					FROM <TABLE/> 
					WHERE <FIELD name='period'/> = ${period}
					AND <FIELD name='domain'/> = ${domain}
					AND <FIELD name='type'/> = ${type}
					AND <FIELD name='name'/> = ${name}
					]]></statement>
			</query>
			<query name="find-all-by-period-type-name" type="SELECT"
				multiple="true">
				<param name="period" />
				<param name="type" />
				<param name="name" />
				<statement><![CDATA[
					SELECT <FIELDS/> 
					FROM <TABLE/> 
					WHERE <FIELD name='period'/> = ${period}
					AND <FIELD name='type'/> = ${type}
					AND <FIELD name='name'/> = ${name}
					]]></statement>
			</query>
			<query name="insert" type="INSERT">
				<statement><![CDATA[
					INSERT 
					INTO <TABLE/>(<FIELDS/>) 
					VALUES(<VALUES/>)
					ON DUPLICATE KEY 
						UPDATE <FIELD name='content'/> = ${content},
							<FIELD name='creation-date'/> = NOW()
				]]></statement>
			</query>
		</query-defs>
	</entity>

	<entity name="task" table="task" alias="t">
		<query-defs>
			<query name="insert" type="INSERT">
				<statement><![CDATA[
				INSERT IGNORE INTO <TABLE/>
					(<FIELDS/>) 
				VALUES
					(<VALUES/>)
				]]></statement>
			</query>
			<query name="find-by-status-consumer" type="SELECT">
				<param name="status" />
				<param name="consumer" />
				<statement><![CDATA[
					SELECT <FIELDS/> 
					FROM <TABLE/> 
					WHERE <FIELD name='status'/> = ${status}
					<IF type='NOT_NULL' field='consumer'>
						AND  <FIELD name='consumer'/> = ${consumer}
					</IF>
				]]></statement>
			</query>

			<query name="update-todo-to-doing" type="UPDATE">
				<statement><![CDATA[
					UPDATE <TABLE/>
					SET <FIELD name='consumer'/>=${consumer}, 
						<FIELD name='status'/>=2, 
						<FIELD name='start-date'/>=${start-date}
					WHERE <FIELD name='status'/> = 1
					AND <FIELD name='id'/> = ${id};
				]]></statement>
			</query>

			<query name="update-doing-to-done" type="UPDATE">
				<statement><![CDATA[
					UPDATE <TABLE/>
					SET <FIELD name='status'/>=3, 
						<FIELD name='end-date'/>=${end-date}
					WHERE <FIELD name='status'/> = 2
					AND <FIELD name='id'/> = ${id};
				]]></statement>
			</query>

			<query name="update-doing-to-fail" type="UPDATE">
				<statement><![CDATA[
					UPDATE <TABLE/>
					SET <FIELD name='status'/>=4, 
						<FIELD name='end-date'/>=${end-date},
						<FIELD name='failure-count'/> = <FIELD name='failure-count'/> + 1
					WHERE <FIELD name='status'/> = 2
					AND <FIELD name='id'/> = ${id};
				]]></statement>
			</query>

		</query-defs>
	</entity>

	<entity name="dailyreport" table="dailyreport" alias="dr">
		<var name="start-date" value-type="Date" />
		<var name="end-date" value-type="Date" />
		<query-defs>
			<query name="find-all-by-domain-name-duration" type="SELECT"
				multiple="true">
				<param name="start-date" />
				<param name="end-date" />
				<param name="domain" />
				<param name="name" />
				<statement><![CDATA[
					SELECT <FIELDS/> 
					FROM <TABLE/> 
					WHERE <FIELD name='period'/> >= ${start-date}
					AND <FIELD name='period'/> < ${end-date}
					AND <FIELD name='domain'/> = ${domain}
					AND <FIELD name='name'/> = ${name}
					]]></statement>
			</query>
			<query name="find-by-name-domain-period" type="SELECT">
				<param name="period" />
				<param name="domain" />
				<param name="name" />
				<statement><![CDATA[
					SELECT <FIELDS/> 
					FROM <TABLE/> 
					WHERE <FIELD name='name'/> = ${name}
					AND <FIELD name='domain'/> = ${domain}
					AND <FIELD name='period'/> = ${period}
				]]></statement>
			</query>
		</query-defs>
	</entity>

	<entity name="graph" table="graph" alias="g">
		<var name="start-date" value-type="Date" />
		<var name="end-date" value-type="Date" />
		<query-defs>
			<query name="insert" type="INSERT">
				<statement><![CDATA[
					INSERT IGNORE INTO <TABLE/>
						(<FIELDS/>) 
					VALUES
						(<VALUES/>) 
				]]></statement>
			</query>
			<query name="find-by-domain-name-ip-duration" type="SELECT" multiple="true">
				<param name="start-date" />
				<param name="end-date" />
				<param name="ip" />
				<param name="domain" />
				<param name="name" />
				<statement><![CDATA[
					SELECT <FIELDS/> 
					FROM <TABLE/> 
					WHERE <FIELD name='name'/> = ${name}
					AND <FIELD name='domain'/> = ${domain}
					<IF type='NOT_NULL' field='ip'>
						AND  <FIELD name='ip'/> = ${ip}
					</IF>
					AND <FIELD name='period'/> >= ${start-date}
					AND <FIELD name='period'/> < ${end-date}
					ORDER BY <FIELD name='period'/> ASC 
				]]></statement>
			</query>
		</query-defs>
	</entity>
</entities>








